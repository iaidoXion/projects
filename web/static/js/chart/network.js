var NETWORK_DATA = {
  "nodes": [
	  {
		"id": "청소년",
		"value": 3,
		"group": null
	  },
	  {
		"id": "장면",
		"value": 3,
		"group": "media"
	  },
	  {
		"id": "드라마",
		"value": 3,
		"group": "media"
	  },
	  {
		"id": "캐릭터",
		"value": 4,
		"group": null
	  },
	  {
		"id": "미디어",
		"value": 4,
		"group": "media"
	  },
	  {
		"id": "대중",
		"value": 4,
		"group": "media"
	  },
	  {
		"id": "영향",
		"value": 2,
		"group": null
	  },
	  {
		"id": "모습",
		"value": 3,
		"group": null
	  },
	  {
		"id": "티비",
		"value": 4,
		"group": "media"
	  },
	  {
		"id": "영화",
		"value": 2,
		"group": "media"
	  },
	  {
		"id": "매체",
		"value": 6,
		"group": "media"
	  },
	  {
		"id": "그리다",
		"value": 5,
		"group": "act"
	  },
	  {
		"id": "소비",
		"value": 5,
		"group": "act"
	  },
	  {
		"id": "이미지",
		"value": 3,
		"group": null
	  },
	  {
		"id": "방송",
		"value": 5,
		"group": "media"
	  },
	  {
		"id": "비행",
		"value": 2,
		"group": "bad"
	  },
	  {
		"id": "주인공",
		"value": 4,
		"group": null
	  },
	  {
		"id": "이야기",
		"value": 5,
		"group": null
	  },
	  {
		"id": "실제표현",
		"value": 5,
		"group": null
	  },
	  {
		"id": "가난",
		"value": 2,
		"group": "bad"
	  },
	  {
		"id": "폭력",
		"value": 3,
		"group": "bad"
	  },
	  {
		"id": "씌우다",
		"value": 4,
		"group": "act"
	  },
	  {
		"id": "묘사",
		"value": 3,
		"group": "act"
	  },
	  {
		"id": "불행",
		"value": 3,
		"group": "bad"
	  },
	  {
		"id": "부정",
		"value": 2,
		"group": "bad"
	  },
	  {
		"id": "인식",
		"value": 1,
		"group": null
	  },
	  {
		"id": "불량",
		"value": 4,
		"group": "bad"
	  }
   ],
  "links": [
	  {
		"source": "청소년",
		"target": "장면",
		"value": 2
	  },
	  {
		"source": "청소년",
		"target": "비행",
		"value": 8
	  },
	  {
		"source": "청소년",
		"target": "티비",
		"value": 4
	  },
	  {
		"source": "청소년",
		"target": "모습",
		"value": 10
	  },
	  {
		"source": "드라마",
		"target": "캐릭터",
		"value": 4
	  },
	  {
		"source": "드라마",
		"target": "미디어",
		"value": 3
	  },
	  {
		"source": "드라마",
		"target": "주인공",
		"value": 2
	  },
	  {
		"source": "드라마",
		"target": "매체",
		"value": 1
	  },
	  {
		"source": "드라마",
		"target": "그리다",
		"value": 4
	  },
	  {
		"source": "장면",
		"target": "비행",
		"value": 5
	  },
	  {
		"source": "장면",
		"target": "주인공",
		"value": 1
	  },
	  {
		"source": "이야기",
		"target": "실제표현",
		"value": 6
	  },
	  {
		"source": "미디어",
		"target": "캐릭터",
		"value": 2
	  },
	  {
		"source": "미디어",
		"target": "매체",
		"value": 8
	  },
	  {
		"source": "미디어",
		"target": "티비",
		"value": 4
	  },
	  {
		"source": "미디어",
		"target": "영화",
		"value": 10
	  },
	  {
		"source": "미디어",
		"target": "실제표현",
		"value": 4
	  },
	  {
		"source": "영향",
		"target": "소비",
		"value": 3
	  },
	  {
		"source": "영향",
		"target": "청소년",
		"value": 2
	  },
	  {
		"source": "영향",
		"target": "대중",
		"value": 1
	  },
	  {
		"source": "영향",
		"target": "미디어",
		"value": 4
	  },
	  {
		"source": "영향",
		"target": "매체",
		"value": 5
	  },
	  {
		"source": "영향",
		"target": "장면",
		"value": 1
	  },
	  {
		"source": "비행",
		"target": "주인공",
		"value": 6
	  },
	  {
		"source": "비행",
		"target": "불량",
		"value": 2
	  },
	  {
		"source": "비행",
		"target": "실제표현",
		"value": 8
	  },
	  {
		"source": "가난",
		"target": "비행",
		"value": 4
	  },
	  {
		"source": "가난",
		"target": "주인공",
		"value": 10
	  },
	  {
		"source": "가난",
		"target": "폭력",
		"value": 4
	  },
	  {
		"source": "가난",
		"target": "이야기",
		"value": 3
	  },
	  {
		"source": "폭력",
		"target": "가난",
		"value": 2
	  },
	  {
		"source": "폭력",
		"target": "실제표현",
		"value": 1
	  },
	  {
		"source": "씌우다",
		"target": "폭력",
		"value": 4
	  },
	  {
		"source": "씌우다",
		"target": "영향",
		"value": 5
	  },
	  {
		"source": "씌우다",
		"target": "소비",
		"value": 1
	  },
	  {
		"source": "씌우다",
		"target": "주인공",
		"value": 6
	  },
	  {
		"source": "씌우다",
		"target": "미디어",
		"value": 2
	  },
	  {
		"source": "씌우다",
		"target": "캐릭터",
		"value": 8
	  },
	  {
		"source": "묘사",
		"target": "씌우다",
		"value": 4
	  },
	  {
		"source": "묘사",
		"target": "불행",
		"value": 10
	  },
	  {
		"source": "묘사",
		"target": "방송",
		"value": 4
	  },
	  {
		"source": "묘사",
		"target": "매체",
		"value": 3
	  },
	  {
		"source": "소비",
		"target": "이미지",
		"value": 2
	  },
	  {
		"source": "소비",
		"target": "그리다",
		"value": 1
	  },
	  {
		"source": "소비",
		"target": "미디어",
		"value": 4
	  },
	  {
		"source": "소비",
		"target": "폭력",
		"value": 5
	  },
	  {
		"source": "매체",
		"target": "대중",
		"value": 1
	  },
	  {
		"source": "매체",
		"target": "영향",
		"value": 6
	  },
	  {
		"source": "매체",
		"target": "모습",
		"value": 2
	  },
	  {
		"source": "매체",
		"target": "이야기",
		"value": 3
	  },
	  {
		"source": "매체",
		"target": "실제표현",
		"value": 10
	  },
	  {
		"source": "부정",
		"target": "인식",
		"value": 10
	  },
	  {
		"source": "부정",
		"target": "이미지",
		"value": 3
	  },
	  {
		"source": "부정",
		"target": "소비",
		"value": 2
	  },
	  {
		"source": "부정",
		"target": "불행",
		"value": 1
	  },
	  {
		"source": "부정",
		"target": "묘사",
		"value": 4
	  },
	  {
		"source": "부정",
		"target": "씌우다",
		"value": 5
	  },
	  {
		"source": "부정",
		"target": "이야기",
		"value": 1
	  }
	]
};

/********network graph********/
		var networkGraph = {
			createGraph : function(){
				var links = NETWORK_DATA.links.map(function(d){
								return Object.create(d)
							});
				var nodes = NETWORK_DATA.nodes.map(function(d){
								return Object.create(d)
							});
				var color = function(d){
					var scale = d3.scaleOrdinal(d3.schemeCategory10);
					return (scale(d.group));
				};
				var fillCircle = function(g){
					if(g == "bad"){
						return "#ff3c00";
					}else if(g=="act"){
						return "#386cff";
					}else if(g=="media"){
						return "#6fbc5b";
					}else{
						return "#c67cff";
					}
				};

				var width = 500;
				var height = 500;

				var simulation = d3.forceSimulation(nodes)
						  .force("link", d3.forceLink(links).id( function(d){ return d.id }))
						  .force("charge", d3.forceManyBody().strength(-100))
						  .force("center", d3.forceCenter(width / 2, height / 2))
						  .force("collide",d3.forceCollide().radius( function(d){ return d.value*8}) );

				//simulation.stop(); // stop 필요한가?


				var svg = d3.select("#NETWORK_GRAPH")
							.attr("viewBox", [0, 0, width, height]);
				var gHolder = svg.append("g")
									.attr("class", "g-holder");
				var link = gHolder.append("g")
								.attr("stroke", "#999")
								.attr("stroke-opacity", 0.6)
							.selectAll("line")
								.data(links)
								.join("line")
									.attr("stroke-width", function(d){ return Math.sqrt(d.value*5)} );

				/*
				var node = svg.append("g")
							.selectAll("circle")
								.data(nodes)
								.enter()
								.append("circle")
									.attr("r", 8)
									.attr("fill", color)
									.call(drag(simulation));  // text 라벨 추가를 위해 g로 그룹핑

				node.append("text")
				  .text(function(d){ return d.id })
				  .style("font-size", "12px") */


				var node = gHolder.append("g")
							.attr("class", "circle-node-holder")
						.selectAll("g")
							.data(nodes)
							.enter()
							.append("g")
							.each(function(d){
								d3.select(this)
									.append("circle")
									.attr("r", d.value*5)
									.attr("fill", fillCircle(d.group));
								d3.select(this)
									.append("text").text(d.id)
									.attr("dy",6)
									.style("text-anchor","middle")
									.attr("class", "node-label")
							}).call(networkGraph.drag(simulation));

				simulation.on("tick", function(){
					link.attr("x1", function(d){ return d.source.x; })
						.attr("y1", function(d){ return d.source.y; })
						.attr("x2", function(d){ return d.target.x; })
						.attr("y2", function(d){ return d.target.y; });

					/*node
						.attr("cx", function(d){ return d.x; })
						.attr("cy", function(d){ return d.y; });*/

					//circle 노드에서 g 노드로 변경
					node.attr("transform", function(d) { return "translate("+d.x+","+ d.y+")"; });
				});

				//invalidation.then(() => simulation.stop());

				return svg.node();
			},
			drag : function(simulation){
				function dragstarted(d) {
					if (!d3.event.active) simulation.alphaTarget(0.3).restart();
					d.fx = d.x;
					d.fy = d.y;
				}

				function dragged(d) {
					d.fx = d3.event.x;
					d.fy = d3.event.y;
				}

				function dragended(d) {
					if (!d3.event.active) simulation.alphaTarget(0);
					d.fx = null;
					d.fy = null;
				}

				return d3.drag()
					.on("start", dragstarted)
					.on("drag", dragged)
					.on("end", dragended);
			}
		}
		/********network graph********/
		networkGraph.createGraph();